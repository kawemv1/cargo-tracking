<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–í—Ö–æ–¥ - Delta Cargo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .login-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            padding: 40px;
            max-width: 450px;
            width: 100%;
        }
        .logo {
            font-size: 2.5rem;
            font-weight: bold;
            color: #667eea;
            text-align: center;
            margin-bottom: 30px;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            padding: 12px;
            font-weight: 600;
        }
        .toggle-link {
            text-align: center;
            margin-top: 20px;
            color: #667eea;
            cursor: pointer;
            text-decoration: underline;
        }
        .forgot-link {
            text-align: right;
            font-size: 0.9rem;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="login-card">
        <div class="logo">üì¶ Delta Cargo</div>
        
        <!-- –§–æ—Ä–º–∞ –≤—Ö–æ–¥–∞ -->
        <div id="login-form-container">
            <h4 class="text-center mb-4">–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É</h4>
            <form id="login-form">
                <div class="mb-3">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-control" id="login-email" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">–ü–∞—Ä–æ–ª—å</label>
                    <input type="password" class="form-control" id="login-password" required>
                </div>
                <div class="forgot-link">
                    <a href="https://t.me/beysenly" target="_blank">–ó–∞–±—ã–ª–∏ –ø–∞—Ä–æ–ª—å?</a>
                </div>
                <button type="submit" class="btn btn-primary w-100 mt-3">–í–æ–π—Ç–∏</button>
            </form>
            <div class="toggle-link" onclick="showRegisterForm()">
                –ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è
            </div>
        </div>

        <!-- –§–æ—Ä–º–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ -->
        <div id="register-form-container" style="display: none;">
            <h4 class="text-center mb-4">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h4>
            <form id="register-form">
                <div class="mb-3">
                    <label class="form-label">–ò–º—è *</label>
                    <input type="text" class="form-control" id="register-name" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Email *</label>
                    <input type="email" class="form-control" id="register-email" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">–ü–∞—Ä–æ–ª—å *</label>
                    <input type="password" class="form-control" id="register-password" required minlength="6">
                    <small class="text-muted">–ú–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤</small>
                </div>
                <div class="mb-3">
                    <label class="form-label">WhatsApp *</label>
                    <input type="text" class="form-control" id="register-whatsapp" placeholder="+77001234567" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">–°–∫–ª–∞–¥ *</label>
                    <select class="form-control" id="register-branch" required>
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å–∫–ª–∞–¥</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary w-100 mt-3">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
            </form>
            <div class="toggle-link" onclick="showLoginForm()">
                –£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? –í–æ–π—Ç–∏
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ñ–æ—Ä–º
        function showRegisterForm() {
            document.getElementById('login-form-container').style.display = 'none';
            document.getElementById('register-form-container').style.display = 'block';
            loadWarehouses();
        }

        function showLoginForm() {
            document.getElementById('login-form-container').style.display = 'block';
            document.getElementById('register-form-container').style.display = 'none';
        }

        // –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–∫–ª–∞–¥—ã –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
        async function loadWarehouses() {
            try {
                const res = await fetch('/api/public/warehouses');
                if (!res.ok) {
                    console.error('Failed to load warehouses:', res.status);
                    return;
                }

                const warehouses = await res.json();
                const select = document.getElementById('register-branch');
                
                select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å–∫–ª–∞–¥</option>';
                
                warehouses.forEach(wh => {
                    const option = document.createElement('option');
                    option.value = wh.name;
                    option.textContent = `${wh.name} (${wh.code})`;
                    select.appendChild(option);
                });
                
                console.log('‚úÖ Warehouses loaded:', warehouses.length);
            } catch (error) {
                console.error('Error loading warehouses:', error);
                alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–∫–ª–∞–¥–æ–≤. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
            }
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥–∞
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            const formData = new FormData();
            formData.append('username', email);
            formData.append('password', password);
            
            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    console.log('‚úÖ Login response:', data);  // –î–ª—è –æ—Ç–ª–∞–¥–∫–∏
                    
                    // ‚úÖ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–æ–∫–µ–Ω
                    localStorage.setItem('token', data.access_token);
                    
                    // ‚úÖ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –í–°–ï –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    localStorage.setItem('user_data', JSON.stringify({
                        name: data.name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',
                        email: data.email,
                        role: data.role,
                        personal_code: data.personal_code || null,
                        branch: data.branch || null
                    }));
                    
                    console.log('‚úÖ Saved to localStorage');
                    
                    // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ —Ä–æ–ª–∏
                    if (data.role === 'superadmin') {
                        window.location.href = '/superadmin';
                    } else if (data.role === 'admin') {
                        window.location.href = '/admin';
                    } else {
                        window.location.href = '/';
                    }
                }
                else {
                    const error = await response.json();
                    let errorMessage = '–ù–µ–≤–µ—Ä–Ω—ã–π email –∏–ª–∏ –ø–∞—Ä–æ–ª—å';
                    
                    if (error.detail) {
                        if (Array.isArray(error.detail)) {
                            errorMessage = error.detail[0].msg || error.detail[0];
                        } else if (typeof error.detail === 'string') {
                            errorMessage = error.detail;
                        }
                    }
                    
                    alert('‚ùå –û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ' + errorMessage);
                }
            } catch (error) {
                console.error('Login exception:', error);
                alert('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ' + error.message);
            }
        });

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
        document.getElementById('register-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const branch = document.getElementById('register-branch').value;
            
            if (!branch) {
                alert('‚ö†Ô∏è –í—ã–±–µ—Ä–∏—Ç–µ —Å–∫–ª–∞–¥');
                return;
            }
            
            const formData = new FormData();
            formData.append('name', document.getElementById('register-name').value);
            formData.append('email', document.getElementById('register-email').value);
            formData.append('password', document.getElementById('register-password').value);
            formData.append('whatsapp', document.getElementById('register-whatsapp').value);
            formData.append('branch', branch);
            formData.append('role', 'client');
            
            console.log('Registering user...');
            
            try {
                const response = await fetch('/api/auth/register', {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    const data = await response.json();
                    alert('‚úÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –¢–µ–ø–µ—Ä—å –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É.');
                    showLoginForm();
                    document.getElementById('login-email').value = data.email;
                } else {
                    const error = await response.json();
                    console.error('Registration error:', error);
                    
                    let errorMessage = '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
                    
                    if (error.detail) {
                        if (Array.isArray(error.detail)) {
                            errorMessage = error.detail[0].msg || error.detail[0];
                        } else if (typeof error.detail === 'string') {
                            errorMessage = error.detail;
                        } else {
                            errorMessage = JSON.stringify(error.detail);
                        }
                    }
                    
                    alert('‚ùå –û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: ' + errorMessage);
                }
            } catch (error) {
                console.error('Registration exception:', error);
                alert('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ' + error.message);
            }
        });
    </script>
</body>
</html>
